<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Tweets</title>
    <style media="screen">
      body {
        font-family: sans-serif;
        font-weight: 100;
      }
      img {
        height: 1.5em; width:1.5em;
        display:inline-block;
        vertical-align: middle;
        margin-right:.5em;
        border-radius: 10%;
      }
      h2 {
        font-weight: 400;
        font-size: 1.2em;
      }
      div{
        max-width: 39em;
        margin: auto;
        border-bottom: 1px solid #eee;
        padding: .5em;
      }
      p {
        font-size: 1.5em;
      }
      a{
        color: #eee;
        text-decoration: none;
        float:right;
      }
      a:hover {
        color:#000
      }
      #container {
        border:none
      }
      .no {
        opacity: 0.4
      }
      hr {
        border:none;
        border-bottom: 1px solid #eee
      }
    </style>
  </head>
  <body>

    <div id='container'></div>

    <script id='template' type='text/ractive'>
      <label class="{{no_sw?'no':'yeah'}}">
        <input type="checkbox" checked="{{sw_active}}" disabled="{{no_sw}}"/> enable service worker
      </label>

      {{#no_sw}}
      <p><em>Service workers are not supported by this browser</em></p>
      {{/no_sw}}

      <hr />


      {{#tweets}}
        <div>
          <h2>
            <img src="{{img}}" />
            @{{screen_name}}
          </h2>
          <p>{{text}} <a href="{{link}}">&rarr;</a></p>
        </div>
      {{/tweets}}
    </script>

    <script src='/ractive.min.js'></script>

    <script>
    var ractive = new Ractive({
      el: '#container',
      template: '#template',
      data: {
        tweets: [],
        no_sw: !('serviceWorker' in navigator),
        sw_active: false
      }
    })

    fetchTweets()
      .then(function(tweets){
        ractive.set('tweets', tweets)
      })


    function fetchTweets() {
      return new Ractive.Promise(function(accept, reject) {
        var request = new XMLHttpRequest()

        request.open('GET', '/json', true)

        request.onload = function() {
          if (request.status >= 200 && request.status < 400)
            accept(JSON.parse(request.responseText))
          else
            reject()
        }

        request.onerror = reject
        request.send()
      })

    }

    // hackily - handle the state of the the service worker

    var skipReg
    navigator.serviceWorker.ready.then(function(){
      ractive.set('sw_active', true)
      skipReg = true
    })

    ractive.observe( 'sw_active', function ( newValue, oldValue, keypath ) {
      if(oldValue === undefined) return console.log("skip")
      if(newValue) {
        if(skipReg) return skipReg = false
        navigator.serviceWorker.register('/sw.js')
      } else {
        navigator.serviceWorker.getRegistrations()
          .then(function(registrations){
            console.log("unregistrations: ", registrations)
            registrations.forEach(function(registration) {
              registration.unregister().then(function(success) {
                console.log("unregister: " + success ? 'successful' : 'unsuccessful')
              })
            })
          })
      }
    })
  </script>
  </body>
</html>
